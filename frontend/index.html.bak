<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>SheStays AI Risk Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="lang.js"></script>
</head>

<body onload="checkAuth()">

    <script src="districts.js"></script>
    <script>
        function checkAuth() {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                window.location.href = 'login.html';
            } else {
                initLanguage();
            }
        }

        function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('username');
            window.location.href = 'login.html';
        }
    </script>

    <div class="navbar">
        <a href="index.html" id="navDashboard">Dashboard</a>
        <a href="action.html" id="navAdd">Add Intervention</a>
        <a href="interventions.html" id="navView">View Interventions</a>
        <a href="#" onclick="logout()" id="navLogout">Logout</a>

        <span class="lang">
            <label>
                <input type="radio" name="lang" value="en" onchange="changeLang('en')"> English
            </label>
            <label>
                <input type="radio" name="lang" value="ta" onchange="changeLang('ta')"> ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç
            </label>
        </span>
    </div>

    <div class="container" id="statsSection" style="margin-bottom: 40px;">
        <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px;">
            <div class="stat-card">
                <h3 id="totalLabel" data-lang="total">Total Students at Risk</h3>
                <p id="totalCount" style="font-size: 24px; font-weight: bold; color: #3498db;">0</p>
            </div>
            <div class="stat-card">
                <h3 id="riskLabel" data-lang="risk">High Risk Alerts</h3>
                <p id="highRiskCount" style="font-size: 24px; font-weight: bold; color: #e74c3c;">0</p>
            </div>
        </div>
    </div>

    <div class="container" id="dashboardSection">
        <h1 id="title" data-lang="title">SheStays ‚Äì Institution Management</h1>

        <div id="institutionGrid" class="institution-grid">
            <!-- Create Institution Card (Always First) -->
            <div id="createCard" class="inst-card create-card" onclick="openCreateModal()">
                <div class="plus-icon">+</div>
                <div class="create-text">Create Institution</div>
            </div>
            <!-- Dynamic Institution Cards rendered here -->
        </div>
    </div>

    <!-- Full-Screen Expansion Overlay -->
    <div id="expansionOverlay" class="overlay">
        <!-- Close Button (X) - Top Right -->
        <button class="btn-close-fs" onclick="closeExpansion()">√ó</button>

        <!-- Tab Bar -->
        <div class="tab-bar">
            <div id="tabInfo" class="tab active" onclick="switchTab('info')">Info</div>
            <div id="tabClassroom" class="tab" onclick="switchTab('classroom')">Classroom</div>
        </div>

        <!-- Info Tab Content -->
        <div id="contentInfo" class="tab-content active">
            <div id="infoBody" class="info-container">
                <!-- Institution details injected here -->
            </div>
        </div>

        <!-- Classroom Tab Content -->
        <div id="contentClassroom" class="tab-content">
            <div id="classroomGrid" class="classroom-grid">
                <!-- Dynamic cards injected here -->
            </div>
        </div>
    </div>

    <!-- Classroom Expansion Overlay -->
    <div id="classroomOverlay" class="overlay">
        <button class="btn-close-fs" onclick="closeClassroomExpansion()">‚úï</button>
        <div class="user-info" style="position:absolute; top:20px; left:40px;">
            <div class="user-avatar" style="width:40px; height:40px; font-size:18px;">C</div>
            <div>
                <div style="font-weight:bold;">Classroom Details</div>
                <div style="font-size:12px; opacity:0.8;">Manager</div>
            </div>
        </div>

        <div style="text-align:center; margin-top:20px;">
            <h1 id="classroomOverlayTitle" style="margin:0; font-size:24px; color:#333;">Classroom Name</h1>
            <div id="classroomOverlaySubtitle" style="color:#666; margin-top:5px;">Class Details</div>
        </div>

        <div class="tab-bar">
            <div class="tab active" onclick="switchClassroomTab('classInfo')" id="tab_classInfo">Class Info</div>
            <div class="tab" onclick="switchClassroomTab('studentData')" id="tab_studentData">Student Data</div>
        </div>

        <div id="content_classInfo" class="tab-content active">
            <!-- Class Info Content Loaded Here -->
        </div>
        <div id="content_studentData" class="tab-content">
            <div class="student-data-container">
                <div class="privacy-notice">
                    üîí Student data is hidden by default for privacy. Click below to load.
                </div>

                <div style="display:flex; gap:12px; margin-bottom:20px;">
                    <button class="btn-load-students" id="btn_load_students" onclick="loadStudentData()">
                        Load Student Data & AI Analysis
                    </button>
                    <button class="btn-add-student" onclick="openAddStudentModal()" style="display:none;"
                        id="btn_add_student">
                        ‚ûï Add Student Profile
                    </button>
                </div>

                <div id="student_list_container" style="display:none;">
                    <!-- Students will be loaded here -->
                </div>

                <div id="ai_analysis_container" style="display:none;">
                    <!-- AI analysis will appear here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Centered Modal Overlay (For Creating/Editing) -->
    <div id="createModalOverlay" class="create-modal-overlay" style="display:none;" onclick="closeCreateModal()">
        <div class="create-modal" onclick="event.stopPropagation()">
            <div class="modal-header"
                style="justify-content: space-between; display: flex; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px;">
                <h2 id="createModalTitle" style="margin:0; font-size: 20px; color: #333;">Create</h2>
                <button class="btn-close" onclick="closeCreateModal()"
                    style="background:none; border:none; font-size:28px; color:#999; cursor:pointer; transition: color 0.2s;">√ó</button>
            </div>
            <div id="createModalBody">
                <!-- Form injected here -->
            </div>
        </div>
    </div>

    <!-- Custom Confirm Dialog Overlay -->
    <div id="confirmOverlay" class="confirm-overlay" style="display: none;" onclick="closeConfirm()">
        <div class="confirm-box" onclick="event.stopPropagation()">
            <h3 id="confirmTitle">Confirm Action</h3>
            <p id="confirmText">Are you sure you want to proceed?</p>
            <div class="confirm-actions">
                <button class="btn-cancel" onclick="closeConfirm()">Cancel</button>
                <button id="confirmBtn" class="btn-danger">Delete</button>
            </div>
        </div>
    </div>

    <script>
        let currentInstitutions = [];
        let currentClassrooms = [];
        let currentOpenedInstId = null;
        let activeEditField = null;

        const API_BASE = "http://localhost:8005";

        function getAuthHeader() {
            return { "Authorization": "Bearer " + localStorage.getItem('auth_token'), "Content-Type": "application/json" };
        }

        function openExpansion(id) {
            currentOpenedInstId = id;
            document.getElementById('expansionOverlay').classList.add('active');
            switchTab('info');
        }

        function closeExpansion() {
            document.getElementById('expansionOverlay').classList.remove('active');
            currentOpenedInstId = null;
        }

        function openCreateModal() {
            document.getElementById('createModalOverlay').style.display = 'flex';
        }

        function closeCreateModal() {
            document.getElementById('createModalOverlay').style.display = 'none';
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            if (tab === 'info') {
                document.getElementById('tabInfo').classList.add('active');
                document.getElementById('contentInfo').classList.add('active');
                renderInfoTab(currentOpenedInstId);
            } else {
                document.getElementById('tabClassroom').classList.add('active');
                document.getElementById('contentClassroom').classList.add('active');
                renderClassroomTab(currentOpenedInstId);
            }
        }

        function renderInfoTab(id) {
            const inst = currentInstitutions.find(i => i.institution_id === id);
            const container = document.getElementById('infoBody');
            if (!inst || !container) return;

            const fields = [
                { label: "Institution Name", key: "institution_name" },
                { label: "State", key: "state" },
                { label: "District", key: "district" },
                { label: "Area/Region", key: "area_region" },
                { label: "Pincode", key: "pincode" },
                { label: "Supervisor Name", key: "supervisor_name" }
            ];

            container.innerHTML = fields.map(f => `
                <div class="field-container">
                    <div class="field-header">
                        <span class="field-label">${f.label}</span>
                        <div id="btn_group_${f.key}">
                            <button class="btn-edit-field" onclick="startEditField('${id}', '${f.key}')">Edit</button>
                        </div>
                    </div>
                    <div class="field-value" id="val_${f.key}">${inst[f.key]}</div>
                </div>
            `).join('');
        }

        function startEditField(id, key) {
            if (activeEditField) return;
            activeEditField = key;

            document.querySelectorAll('.btn-edit-field').forEach(b => b.disabled = true);
            const btnGroup = document.getElementById(`btn_group_${key}`);
            const valDiv = document.getElementById(`val_${key}`);
            const inst = currentInstitutions.find(i => i.institution_id === id);

            btnGroup.innerHTML = `
                <button class="btn-edit-field save" style="background:#5cb85c;" onclick="saveField('${id}', '${key}')">Save</button>
                <button class="btn-edit-field cancel" style="background:#6c757d; margin-left:5px;" onclick="cancelEditField('${id}', '${key}')">Cancel</button>
            `;

            if (key === 'state') {
                valDiv.innerHTML = `<select id="edit_${key}" class="inline-input" onchange="updateDistricts('edit_${key}', 'edit_district')"></select>`;
                populateStates(`edit_${key}`);
                document.getElementById(`edit_${key}`).value = inst[key];
            } else if (key === 'district') {
                valDiv.innerHTML = `<select id="edit_${key}" class="inline-input"></select>`;
                const stateVal = inst['state'];
                const distSelect = document.getElementById(`edit_${key}`);
                distSelect.innerHTML = '<option value="">-- Select District --</option>';
                if (stateVal && stateDistrictMap[stateVal]) {
                    stateDistrictMap[stateVal].sort().forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = opt.textContent = d;
                        if (d === inst[key]) opt.selected = true;
                        distSelect.appendChild(opt);
                    });
                }
            } else {
                valDiv.innerHTML = `<input type="text" id="edit_${key}" class="inline-input" value="${inst[key]}">`;
            }
        }

        function cancelEditField(id, key) {
            activeEditField = null;
            renderInfoTab(id);
        }

        function saveField(id, key) {
            let newVal;
            if (document.getElementById(`edit_${key}`)) {
                newVal = document.getElementById(`edit_${key}`).value;
            } else {
                newVal = "";
            }

            const updateObj = {};
            updateObj[key] = newVal;

            // Simple Validations
            if (key === 'pincode' && !/^[0-9]{6}$/.test(newVal)) {
                alert("Invalid Pincode: Must be 6 digits"); return;
            }
            if (['institution_name', 'supervisor_name', 'area_region'].includes(key) && newVal.length < 3) {
                alert("Field must be at least 3 characters"); return;
            }

            updateAPI(id, updateObj, () => {
                const inst = currentInstitutions.find(i => i.institution_id === id);
                inst[key] = newVal;
                activeEditField = null;
                renderInfoTab(id);
                loadInstitutions(); // Refresh grid too
            });
        }

        // --- Classroom Logic ---

        function renderClassroomTab(instId) {
            const grid = document.getElementById('classroomGrid');
            // Ensure first card is "Create"
            grid.innerHTML = `<div class="create-cls-card" onclick="openCreateClassroomModal('${instId}')"><div class="plus-icon">+</div><div style="margin-top:10px; color:#555; font-weight:500;">Create Classroom</div></div>`;

            fetch(`${API_BASE}/api/classrooms?institution_id=${instId}`, {
                headers: getAuthHeader()
            }).then(res => {
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                return res.json();
            }).then(data => {
                if (data.success && Array.isArray(data.classrooms)) {
                    currentClassrooms = data.classrooms;
                    data.classrooms.forEach(cls => { grid.innerHTML += renderClassroomCard(cls); });
                } else {
                    console.warn("Unexpected classroom data format:", data);
                }
            }).catch(e => console.error("Error fetching classrooms:", e));
        }

        let currentOpenedClassId = null;

        function renderClassroomCard(cls) {
            return `<div class="class-card" id="cls_card_${cls.classroom_id}" onclick="openClassroomExpansion('${cls.classroom_id}')">
                <div class="cls-content-box" id="cls_content_box_${cls.classroom_id}">
                    <div class="cls-header" style="justify-content:space-between; padding:15px;" >
                        <div class="cls-title-section" id="cls_title_${cls.classroom_id}">
                            <span class="cls-name" style="font-size:16px; font-weight:bold;">${cls.classroom_name}</span>
                        </div>
                        <div class="cls-actions">
                            <button class="btn-small btn-edit-name" onclick="event.stopPropagation(); openEditClassroomModal('${cls.classroom_id}')">Edit</button>
                            <button class="btn-small btn-delete" onclick="event.stopPropagation(); confirmDeleteClassroom('${cls.classroom_id}', '${cls.classroom_name}')">Delete</button>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function openClassroomExpansion(classId) {
            currentOpenedClassId = classId;
            const cls = currentClassrooms.find(c => c.classroom_id === classId);
            if (!cls) return;

            document.getElementById('classroomOverlayTitle').innerText = cls.classroom_name;
            document.getElementById('classroomOverlaySubtitle').innerText = `${cls.grade} - ${cls.section}`;

            renderClassroomInfoTab(cls);

            const overlay = document.getElementById('classroomOverlay');
            overlay.classList.add('active');

            // Default to Class Info tab
            switchClassroomTab('classInfo');
        }

        function toggleClassroomExpansion(id) {
            const card = document.getElementById(`cls_card_${id}`);
            const details = document.getElementById(`cls_details_${id}`);
            const icon = card.querySelector('.cls-expand-icon');

            if (card.classList.contains('expanded')) {
                card.classList.remove('expanded');
                icon.style.transform = 'rotate(0deg)';
            } else {
                card.classList.add('expanded');
                icon.style.transform = 'rotate(180deg)';
            }
        }

        <!-- startEditClassroomName removed -->

        function cancelEditClassroomName(id) {
            const cls = currentClassrooms.find(c => c.classroom_id === id);
            const titleSection = document.getElementById(`cls_title_${id}`);
            titleSection.innerHTML = `<span class="cls-name">${cls.classroom_name}</span>`;
        }

        function saveClassroomName(id) {
            const newName = document.getElementById(`cls_input_${id}`).value;
            if (newName.length < 1) return;

            updateClassroomAPI(id, { classroom_name: newName }, () => {
                const cls = currentClassrooms.find(c => c.classroom_id === id);
                cls.classroom_name = newName;
                cancelEditClassroomName(id); // Revert UI
            });
        }

        function updateClassroomAPI(id, data, callback) {
            fetch(`${API_BASE}/api/classrooms/${id}`, {
                method: "PATCH",
                headers: getAuthHeader(),
                body: JSON.stringify(data)
            }).then(res => res.json()).then(d => { if (d.success) callback(); });
        }

        function closeClassroomExpansion() {
            const overlay = document.getElementById('classroomOverlay');
            overlay.classList.remove('active');
            currentOpenedClassId = null;
        }

        function switchClassroomTab(tabName) {
            // Hide all tabs
            ['classInfo', 'studentData'].forEach(t => {
                document.getElementById(`content_${t}`).style.display = 'none';
                document.getElementById(`tab_${t}`).classList.remove('active');
            });

            // Show selected
            document.getElementById(`content_${tabName}`).style.display = 'block';
            document.getElementById(`tab_${tabName}`).classList.add('active');
        }

        function renderClassroomInfoTab(cls) {
            const container = document.getElementById('content_classInfo');
            container.innerHTML = `
                <div class="info-container">
                    <div class="field-container">
                        <div class="field-header">
                            <div><strong>Grade</strong></div>
                        </div>
                        <div>${cls.grade}</div>
                    </div>
                    <div class="field-container">
                        <div class="field-header">
                            <div><strong>Section</strong></div>
                        </div>
                        <div>${cls.section}</div>
                    </div>
                    <div class="field-container">
                        <div class="field-header">
                            <div><strong>Total Students</strong></div>
                        </div>
                        <div>${cls.total_students}</div>
                    </div>
                    <div class="field-container">
                        <div class="field-header">
                            <div><strong>Class Teacher</strong></div>
                        </div>
                        <div>${cls.class_teacher}</div>
                    </div>
                    <div style="margin-top:20px; text-align:right;">
                         <button class="btn-edit-cls" onclick="openEditClassroomModal('${cls.classroom_id}')">Edit Details</button>
                    </div>
                </div>
            `;
        }

        // Student Data Functions
        async function loadStudentData() {
            if (!currentOpenedClassId) return;

            const btn = document.getElementById('btn_load_students');
            const listContainer = document.getElementById('student_list_container');
            const analysisContainer = document.getElementById('ai_analysis_container');

            // Disable button and show loading
            btn.disabled = true;
            btn.textContent = 'Loading...';

            try {
                // Fetch students
                const studentsRes = await fetch(`${API_BASE}/api/classrooms/${currentOpenedClassId}/students`, {
                    headers: getAuthHeader()
                });
                const studentsData = await studentsRes.json();

                if (!studentsData.success) {
                    listContainer.innerHTML = '<div class="error">Failed to load students</div>';
                    listContainer.style.display = 'block';
                    return;
                }

                const students = studentsData.students;

                if (students.length === 0) {
                    listContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">No students in this classroom yet.</div>';
                    listContainer.style.display = 'block';
                    btn.style.display = 'none';
                    return;
                }

                // Render student cards
                listContainer.innerHTML = '<h3 style="margin-bottom:16px;">Students</h3>' +
                    students.map(s => renderStudentCard(s)).join('');
                listContainer.style.display = 'block';

                // Show Add Student button
                document.getElementById('btn_add_student').style.display = 'inline-block';

                // Trigger AI analysis
                analysisContainer.style.display = 'block';
                analysisContainer.innerHTML = '<div class="ai-loading">ü§ñ Analyzing with Qwen AI...</div>';

                const analysisRes = await fetch(`${API_BASE}/api/classrooms/${currentOpenedClassId}/analyze-risk`, {
                    method: 'POST',
                    headers: getAuthHeader()
                });
                const analysisData = await analysisRes.json();

                if (analysisData.success) {
                    renderAIAnalysis(analysisData.analysis, analysisContainer);
                } else {
                    analysisContainer.innerHTML = '<div class="ai-error">AI analysis unavailable</div>';
                }

                // Hide button after loading
                btn.style.display = 'none';

            } catch (error) {
                listContainer.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                listContainer.style.display = 'block';
                btn.disabled = false;
                btn.textContent = 'Load Student Data & AI Analysis';
            }
        }

        function renderStudentCard(student) {
            const attendance = student.attendance_percent || 0;
            const marks = student.current_marks || 0;
            const isHighRisk = attendance < 70 || marks < 60;

            return `
                <div class="student-card collapsed" id="student_${student.student_id}">
                    <div class="student-header" onclick="toggleStudentCard('${student.student_id}')">
                        <div class="student-avatar ${isHighRisk ? 'high-risk' : ''}">${student.name ? student.name[0] : 'S'}</div>
                        <div class="student-name">${student.name || 'Unknown'}</div>
                        ${isHighRisk ? '<span class="risk-badge">‚ö†Ô∏è High Risk</span>' : ''}
                        <div class="expand-icon">‚ñº</div>
                    </div>
                    <div class="student-details" style="display:none;">
                        <div class="detail-row">
                            <strong>Attendance:</strong> ${attendance.toFixed(1)}%
                        </div>
                        <div class="detail-row">
                            <strong>Current Marks:</strong> ${marks}%
                        </div>
                        <div class="detail-row">
                            <strong>Previous Marks:</strong> ${student.previous_marks || 0}%
                        </div>
                        <div class="detail-row">
                            <strong>Failed Subjects:</strong> ${student.failed_subjects || 0}
                        </div>
                        <div class="detail-row">
                            <strong>Total Absences:</strong> ${student.days_absent || 0} days
                        </div>
                        <div class="student-actions" style="margin-top:12px; display:flex; gap:8px;">
                            <button class="btn-edit-student" onclick="event.stopPropagation(); openEditStudentModal('${student.student_id}')">‚úèÔ∏è Edit</button>
                            <button class="btn-delete-student" onclick="event.stopPropagation(); deleteStudentProfile('${student.student_id}')">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleStudentCard(studentId) {
            const card = document.getElementById(`student_${studentId}`);
            const details = card.querySelector('.student-details');
            const icon = card.querySelector('.expand-icon');

            if (details.style.display === 'none') {
                details.style.display = 'block';
                icon.textContent = '‚ñ≤';
                card.classList.remove('collapsed');
            } else {
                details.style.display = 'none';
                icon.textContent = '‚ñº';
                card.classList.add('collapsed');
            }
        }

        function renderAIAnalysis(analysis, container) {
            const highRisk = analysis.highRiskStudents || [];

            if (highRisk.length === 0) {
                container.innerHTML = '<div class="ai-result success">‚úÖ No high-risk students identified by AI</div>';
                return;
            }

            container.innerHTML = `
                <div class="ai-result warning">
                    <h4>‚ö†Ô∏è ${highRisk.length} High-Risk Students Identified by Qwen AI</h4>
                    <ul>
                        ${highRisk.map(s => `<li><strong>Student ID ${s.id}:</strong> ${s.reason}</li>`).join('')}
                    </ul>
                    <div style="margin-top:12px; font-size:12px; color:#666;">
                        üí° Powered by Qwen 2.5 (1.5B) running locally
                    </div>
                </div>
            `;
        }

        // ========== STUDENT PROFILE MANAGEMENT ==========

        let currentStep = 1;
        const totalSteps = 5;

        function openAddStudentModal() {
            if (!currentOpenedClassId) return;

            document.getElementById('studentModalTitle').textContent = 'Add Student Profile';
            document.getElementById('student_id_hidden').value = '';
            document.getElementById('classroom_id_hidden').value = currentOpenedClassId;
            document.getElementById('studentProfileForm').reset();
            currentStep = 1;
            showStep(1);
            document.getElementById('studentProfileModal').style.display = 'flex';
        }

        function openEditStudentModal(studentId) {
            fetch(`${API_BASE}/api/classrooms/${currentOpenedClassId}/students`, {
                headers: getAuthHeader()
            })
                .then(res => res.json())
                .then(data => {
                    const student = data.students.find(s => s.student_id === studentId);
                    if (!student) return;

                    document.getElementById('studentModalTitle').textContent = 'Edit Student Profile';
                    document.getElementById('student_id_hidden').value = studentId;
                    document.getElementById('classroom_id_hidden').value = currentOpenedClassId;

                    document.getElementById('student_name').value = student.name || '';
                    document.getElementById('student_age').value = student.age || 0;
                    document.getElementById('student_grade').value = student.grade || '';
                    document.getElementById('school_location').value = student.school_location || 'Urban';

                    document.getElementById('total_days').value = student.total_days || 0;
                    document.getElementById('days_present').value = student.days_present || 0;
                    document.getElementById('days_absent').value = student.days_absent || 0;
                    document.getElementById('longest_absence').value = student.longest_absence || 0;

                    document.getElementById('current_marks').value = student.current_marks || 0;
                    document.getElementById('previous_marks').value = student.previous_marks || 0;
                    document.getElementById('failed_subjects').value = student.failed_subjects || 0;
                    document.getElementById('failed_subjects_previous').value = student.failed_subjects_previous || 0;

                    document.getElementById('family_income').value = student.family_income || 0;
                    document.getElementById('parent_education').value = student.parent_education || 'None';
                    document.getElementById('parent_attitude').value = student.parent_attitude || 'Supportive';
                    document.getElementById('has_study_device').checked = student.has_study_device || false;
                    document.getElementById('student_works').checked = student.student_works || false;
                    document.getElementById('household_work_hours').value = student.household_work_hours || 0;
                    document.getElementById('family_migrates').checked = student.family_migrates || false;
                    document.getElementById('early_marriage_risk').checked = student.early_marriage_risk || false;

                    document.getElementById('nutrition_status').value = student.nutrition_status || 'Normal';
                    document.getElementById('health_absences').value = student.health_absences || 0;
                    document.getElementById('menstrual_hygiene').value = student.menstrual_hygiene || 'Adequate';
                    document.getElementById('long_term_illness').checked = student.long_term_illness || false;
                    document.getElementById('distance_to_school').value = student.distance_to_school || 0;
                    document.getElementById('travel_mode').value = student.travel_mode || 'Walk';
                    document.getElementById('route_safety_concerns').checked = student.route_safety_concerns || false;
                    document.getElementById('girls_toilets_available').checked = student.girls_toilets_available !== false;

                    currentStep = 1;
                    showStep(1);
                    document.getElementById('studentProfileModal').style.display = 'flex';
                });
        }

        function closeStudentModal() {
            document.getElementById('studentProfileModal').style.display = 'none';
            document.getElementById('studentProfileForm').reset();
        }

        function nextStep() {
            if (currentStep < totalSteps) {
                currentStep++;
                showStep(currentStep);
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        function showStep(step) {
            document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));

            document.querySelector(`.form-step[data-step="${step}"]`).classList.add('active');
            document.querySelector(`.step[data-step="${step}"]`).classList.add('active');

            document.querySelector('.btn-prev').style.display = step === 1 ? 'none' : 'inline-block';
            document.querySelector('.btn-next').style.display = step === totalSteps ? 'none' : 'inline-block';
            document.querySelector('.btn-save-student').style.display = step === totalSteps ? 'inline-block' : 'none';
        }

        function deleteStudentProfile(studentId) {
            if (!confirm('Are you sure you want to delete this student profile?')) return;

            fetch(`${API_BASE}/api/students/${studentId}`, {
                method: 'DELETE',
                headers: getAuthHeader()
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('Student deleted successfully');
                        loadStudentData();
                    } else {
                        alert('Error deleting student');
                    }
                });
        }

        // Form submission handler
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('studentProfileForm');
            if (form) {
                form.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const studentId = document.getElementById('student_id_hidden').value;
                    const isEdit = !!studentId;

                    const studentData = {
                        classroom_id: document.getElementById('classroom_id_hidden').value,
                        name: document.getElementById('student_name').value,
                        age: parseInt(document.getElementById('student_age').value),
                        grade: document.getElementById('student_grade').value,
                        school_location: document.getElementById('school_location').value,
                        total_days: parseInt(document.getElementById('total_days').value),
                        days_present: parseInt(document.getElementById('days_present').value),
                        days_absent: parseInt(document.getElementById('days_absent').value),
                        longest_absence: parseInt(document.getElementById('longest_absence').value),
                        current_marks: parseFloat(document.getElementById('current_marks').value),
                        previous_marks: parseFloat(document.getElementById('previous_marks').value),
                        failed_subjects: parseInt(document.getElementById('failed_subjects').value),
                        failed_subjects_previous: parseInt(document.getElementById('failed_subjects_previous').value),
                        family_income: parseFloat(document.getElementById('family_income').value),
                        parent_education: document.getElementById('parent_education').value,
                        parent_attitude: document.getElementById('parent_attitude').value,
                        has_study_device: document.getElementById('has_study_device').checked,
                        student_works: document.getElementById('student_works').checked,
                        household_work_hours: parseFloat(document.getElementById('household_work_hours').value),
                        family_migrates: document.getElementById('family_migrates').checked,
                        early_marriage_risk: document.getElementById('early_marriage_risk').checked,
                        nutrition_status: document.getElementById('nutrition_status').value,
                        health_absences: parseInt(document.getElementById('health_absences').value),
                        menstrual_hygiene: document.getElementById('menstrual_hygiene').value,
                        long_term_illness: document.getElementById('long_term_illness').checked,
                        distance_to_school: parseFloat(document.getElementById('distance_to_school').value),
                        travel_mode: document.getElementById('travel_mode').value,
                        route_safety_concerns: document.getElementById('route_safety_concerns').checked,
                        girls_toilets_available: document.getElementById('girls_toilets_available').checked
                    };

                    try {
                        const url = isEdit ? `${API_BASE}/api/students/${studentId}` : `${API_BASE}/api/students`;
                        const method = isEdit ? 'PATCH' : 'POST';

                        const response = await fetch(url, {
                            method: method,
                            headers: getAuthHeader(),
                            body: JSON.stringify(studentData)
                        });

                        const result = await response.json();

                        if (result.success) {
                            alert(isEdit ? 'Student updated successfully!' : 'Student created successfully!');
                            closeStudentModal();
                            loadStudentData();
                        } else {
                            alert('Error: ' + (result.detail || 'Failed to save student'));
                        }
                    } catch (error) {
                        alert('Error: ' + error.message);
                    }
                });
            }
        });

        function openCreateClassroomModal(instId) {
            document.getElementById('createModalTitle').innerText = "Create Classroom";
            const body = document.getElementById('createModalBody');
            body.innerHTML = renderClassroomForm();
            // Hook up save button
            document.getElementById('btnSaveClassroom').onclick = () => submitNewClassroom(instId);
            openCreateModal();
        }

        function openEditClassroomModal(classId) {
            const cls = currentClassrooms.find(c => c.classroom_id === classId);
            if (!cls) return;
            document.getElementById('createModalTitle').innerText = "Edit Classroom";
            const body = document.getElementById('createModalBody');
            body.innerHTML = renderClassroomForm(cls);
            document.getElementById('btnSaveClassroom').onclick = () => submitEditClassroom(classId);
            openCreateModal();
        }

        function renderClassroomForm(cls = {}) {
            return `<div style="display:flex; flex-direction:column; gap:15px;">
                <!-- Classroom Name removed as it is auto-generated -->
                <div>
                    <label class="field-label">Grade</label>
                    <select id="cls_grade" class="inline-input">
                        <option value="">-- Grade --</option>
                        ${[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12].map(g => `<option value="${g}" ${cls.grade == g ? 'selected' : ''}>${g}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="field-label">Section</label>
                    <input type="text" id="cls_section" class="inline-input" placeholder="e.g., A, B, C" value="${cls.section || ''}">
                </div>
                <div>
                    <label class="field-label">Total Students</label>
                    <input type="number" id="cls_students" class="inline-input" placeholder="Count" value="${cls.total_students || ''}">
                </div>
                <div>
                    <label class="field-label">Class Teacher</label>
                    <input type="text" id="cls_teacher" class="inline-input" placeholder="Name" value="${cls.class_teacher || ''}">
                </div>
                <div id="clsError" class="error-msg" style="display:none; color:red; font-size:14px;">Please fill all fields correctly.</div>
                <button id="btnSaveClassroom" class="btn-edit-field save" style="width:100%; height:40px; margin-top:10px; background:#4A90E2; color:white; border:none;">Save Classroom</button>
            </div>`;
        }

        function submitNewClassroom(instId) {
            const data = getClassroomFormData();
            if (!data) return;
            data.institution_id = instId;

            fetch(`${API_BASE}/api/classrooms`, {
                method: "POST",
                headers: getAuthHeader(),
                body: JSON.stringify(data)
            }).then(res => res.json()).then(resData => {
                if (resData.success) {
                    closeCreateModal();
                    renderClassroomTab(instId);
                }
            });
        }

        function submitEditClassroom(classId) {
            const data = getClassroomFormData();
            if (!data) return;

            fetch(`${API_BASE}/api/classrooms/${classId}`, {
                method: "PATCH",
                headers: getAuthHeader(),
                body: JSON.stringify(data)
            }).then(res => res.json()).then(d => {
                if (d.success) {
                    closeCreateModal();
                    renderClassroomTab(currentOpenedInstId);
                }
            });
        }

        function getClassroomFormData() {
            const grade = document.getElementById('cls_grade').value;
            const section = document.getElementById('cls_section').value;
            let students = document.getElementById('cls_students').value;
            const teacher = document.getElementById('cls_teacher').value;

            if (!grade || !section || !students || !teacher) {
                document.getElementById('clsError').style.display = 'block'; return null;
            }

            // Auto-generate name based on Grade + Section
            const name = `Class ${grade}-${section}`;

            return {
                classroom_name: name,
                grade: parseInt(grade),
                section: section,
                total_students: parseInt(students),
                class_teacher: teacher
            };
        }

        function confirmDeleteClassroom(classId, name) {
            document.getElementById('confirmText').innerText = `Are you sure you want to delete classroom "${name}"?`;
            document.getElementById('confirmOverlay').style.display = 'flex';
            document.getElementById('confirmBtn').onclick = () => {
                fetch(`${API_BASE}/api/classrooms/${classId}`, {
                    method: "DELETE",
                    headers: getAuthHeader()
                }).then(res => res.json()).then(d => { if (d.success) { closeConfirm(); renderClassroomTab(currentOpenedInstId); } });
            };
        }

        // --- Institution Logic ---

        function loadInstitutions() {
            fetch(`${API_BASE}/api/institutions`, {
                headers: getAuthHeader()
            }).then(res => {
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                return res.json();
            }).then(data => {
                if (!Array.isArray(data)) {
                    console.error("Expected array from /api/institutions, got:", data);
                    // Handle non-array response (e.g. error message)
                    return;
                }
                currentInstitutions = data;
                const grid = document.getElementById('institutionGrid');
                // Create Card
                grid.innerHTML = `<div id="createCard" class="inst-card create-card" onclick="openCreateInstitutionModal()"><div class="plus-icon">+</div><div class="create-text">Create Institution</div></div>`;
                data.forEach(inst => renderInstitutionCard(inst));
            }).catch(err => console.error("Error loading institutions:", err));
        }

        function renderInstitutionCard(inst) {
            const grid = document.getElementById('institutionGrid');
            const card = document.createElement('div');
            card.className = 'inst-card';
            card.id = `card_${inst.institution_id}`;
            card.onclick = () => openExpansion(inst.institution_id);
            card.innerHTML = `<div id="content_box_${inst.institution_id}" style="width:100%; text-align:center;">
                <h2 id="name_display_${inst.institution_id}">${inst.institution_name}</h2>
                <div class="subtitle" style="color:#666; font-size:14px; margin-bottom:15px;">${inst.district || 'Unknown District'}</div>
                <div class="card-actions" id="actions_${inst.institution_id}">
                    <button class="btn-small btn-edit-name" onclick="event.stopPropagation(); startEditName('${inst.institution_id}')">Edit Name</button>
                    <button class="btn-small btn-delete" onclick="event.stopPropagation(); confirmDelete('${inst.institution_id}', '${inst.institution_name}')">Delete</button>
                </div>
            </div>`;
            grid.appendChild(card);
        }

        function openCreateInstitutionModal() {
            document.getElementById('createModalTitle').innerText = "Create Institution";
            const body = document.getElementById('createModalBody');
            body.innerHTML = `<div style="display:flex; flex-direction:column; gap:15px;">
                <input type="text" id="new_instName" class="inline-input" placeholder="Institution Name">
                <select id="new_instState" class="inline-input" onchange="updateDistricts('new_instState', 'new_instDistrict')"><option value="">-- State --</option></select>
                <select id="new_instDistrict" class="inline-input"><option value="">-- District --</option></select>
                <input type="text" id="new_instArea" class="inline-input" placeholder="Area / Region">
                <input type="text" id="new_instPincode" class="inline-input" placeholder="Pincode (6 digits)" maxlength="6">
                <input type="text" id="new_instSupervisor" class="inline-input" placeholder="Supervisor Name">
                <div id="createError" class="error-msg" style="display:none; color:red;">Please fill all fields.</div>
                <button class="btn-edit-field save" style="width:100%; height:40px; margin-top:10px; background:#4A90E2; color:white; border:none;" onclick="submitNewInstitution()">Save</button>
            </div>`;
            populateStates('new_instState');
            openCreateModal();
        }

        function submitNewInstitution() {
            const data = {
                institution_name: document.getElementById('new_instName').value,
                state: document.getElementById('new_instState').value,
                district: document.getElementById('new_instDistrict').value,
                area_region: document.getElementById('new_instArea').value,
                pincode: document.getElementById('new_instPincode').value,
                supervisor_name: document.getElementById('new_instSupervisor').value
            };
            if (!validateData(data)) { document.getElementById('createError').style.display = 'block'; return; }

            fetch(`${API_BASE}/api/institutions`, {
                method: "POST",
                headers: getAuthHeader(),
                body: JSON.stringify(data)
            }).then(res => res.json()).then(d => { if (d.success) { closeCreateModal(); loadInstitutions(); } });
        }

        function startEditName(id) {
            const inst = currentInstitutions.find(i => i.institution_id === id);
            const contentBox = document.getElementById(`content_box_${id}`);
            contentBox.innerHTML = `<input type="text" class="inline-input" id="input_${id}" value="${inst.institution_name}" style="margin-bottom:15px;" onclick="event.stopPropagation()">
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button class="btn-mini-save" style="background:#5cb85c; color:white; border:none; padding:5px 15px; border-radius:4px;" onclick="event.stopPropagation(); saveName('${id}')">Save</button>
                    <button class="btn-mini-save" style="background:#6c757d; color:white; border:none; padding:5px 15px; border-radius:4px;" onclick="event.stopPropagation(); loadInstitutions()">Cancel</button>
                </div>`;
            document.getElementById(`input_${id}`).focus();
        }

        function saveName(id) {
            const newName = document.getElementById(`input_${id}`).value;
            if (newName.length < 3) return;
            updateAPI(id, { institution_name: newName }, () => { loadInstitutions(); });
        }

        function updateAPI(id, data, callback) {
            fetch(`${API_BASE}/api/institutions/${id}`, {
                method: "PATCH",
                headers: getAuthHeader(),
                body: JSON.stringify(data)
            }).then(res => res.json()).then(d => { if (d.success) callback(d.data); });
        }

        function confirmDelete(id, name) {
            document.getElementById('confirmText').innerText = `Delete "${name}"?`;
            document.getElementById('confirmOverlay').style.display = 'flex';
            document.getElementById('confirmBtn').onclick = () => {
                fetch(`${API_BASE}/api/institutions/${id}`, {
                    method: "DELETE",
                    headers: getAuthHeader()
                }).then(res => res.json()).then(d => { if (d.success) { closeConfirm(); loadInstitutions(); } });
            };
        }

        function closeConfirm() { document.getElementById('confirmOverlay').style.display = 'none'; }

        function validateData(data) {
            return (data.institution_name?.length >= 3 && data.state && data.district && data.area_region?.length >= 3 && /^[0-9]{6}$/.test(data.pincode) && data.supervisor_name?.length >= 3);
        }

        function populateStates(id) {
            const s = document.getElementById(id); if (!s) return;
            Object.keys(stateDistrictMap).sort().forEach(st => { const o = document.createElement('option'); o.value = o.textContent = st; s.appendChild(o); });
        }
        function updateDistricts(sid, did, val = '') {
            const s = document.getElementById(sid).value; const d = document.getElementById(did); if (!d) return;
            d.innerHTML = '<option value="">-- District --</option>';
            if (s && stateDistrictMap[s]) stateDistrictMap[s].sort().forEach(dist => { const o = document.createElement('option'); o.value = o.textContent = dist; if (dist === val) o.selected = true; d.appendChild(o); });
        }

        function loadStats() {
            fetch(`${API_BASE}/dashboard/stats`, {
                headers: getAuthHeader()
            }).then(res => {
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                return res.json();
            })
                .then(data => {
                    document.getElementById('totalCount').innerText = data.total_students;
                    document.getElementById('highRiskCount').innerText = data.risk_distribution.High || 0;
                }).catch(err => console.error("Error loading stats:", err));
        }

        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeExpansion(); closeCreateModal(); closeConfirm(); } });

        const originalInit = initLanguage;
        initLanguage = function () {
            if (originalInit) originalInit();
            loadInstitutions();
            loadStats();
        };
    </script>
</body>

</html>